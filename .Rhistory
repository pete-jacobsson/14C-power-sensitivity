xlab = "Offset magnitude")
plot_simulation_results_osc <- function(range_to_plot, hpd_area, variable,
rounding, xlab) {
##This function plots the simulation results for the purposes of the results graphing
single_cals_curve_uncert_mod <- read_csv("single_cals_w_curve_uncert.csv") %>%
mutate(sigma_curve_uncert = sqrt((measurement_error^2) + (curve_uncert^2)))
single_cals_curve_uncert_mod %>%
rename(variable_to_plot = variable, hpd_to_plot = hpd_area) %>%
filter(variable_to_plot >= range_to_plot[1] &
variable_to_plot <= range_to_plot) %>%
mutate(
variable_to_plot = plyr::round_any(variable_to_plot, rounding)
) %>%
select(variable_to_plot, hpd_to_plot) %>%
group_by(variable_to_plot) %>%
summarize(
ratio_accurate = mean(hpd_to_plot)
) %>%
ggplot(aes(x = variable_to_plot, y = ratio_accurate)) +
geom_bar(stat = 'identity', fill = "steelblue") +
theme_bw() +
theme(
panel.grid.minor = element_blank(),
panel.grid.major = element_blank(),
panel.border = element_blank(),
axis.line = element_line(colour = "grey50", linewidth = 0.5),
text = element_text(family = "Corbel")#,
#axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, size = 9)
) +
labs(
y = "Ratio accurate",
x = xlab
)
}
p <- plot_simulation_results_osc(range_to_plot = c(0, 50), hpd_area = "accuracy_68",
variable = "offset_magnitude", rounding = 2,
xlab = "Offset magnitude")
for (i in 1:50) {
sigma_curve_uncert <- sample(single_cals_w_curve_uncert$sigma_curve_uncert, 1)
sample_predict <- draw_predict_random(posterior_68_pos, "offset",
seq(0, 50, 1), sigma_curve_uncert) |>
rename(variable_to_plot = 1, ratio_accurate = 2)
p <- p + geom_line(data = sample_predict, linewidth = 0.1, linetype = 1)
}
median_predicts <- draw_predict_median(posterior_68_pos, "offset",
seq(0, 50, 1), 25) |>
rename(variable_to_plot = 1, ratio_accurate = 2)
p + geom_line(data = median_predicts)
library(tidyverse)
library(broom)
library(jtools)
library(rstan)
library(rstanarm)
library(bayesplot)
stan_offset_curve_sigma_comb <- read_rds("stan_offset_curve_sigma_comb.rds")
posterior_68_pos <- as.array(stan_offset_curve_sigma_comb[[1]])
posterior_68_neg <- as.array(stan_offset_curve_sigma_comb[[2]])
posterior_95_pos <- as.array(stan_offset_curve_sigma_comb[[3]])
posterior_95_neg <- as.array(stan_offset_curve_sigma_comb[[4]])
color_scheme_set("blue")
mcmc_hist(posterior_68_pos, pars = c("(Intercept)", "offset_magnitude",
"sigma_curve_uncert"))
mcmc_hist(posterior_68_neg, pars = c("(Intercept)", "offset_magnitude",
"sigma_curve_uncert"))
mcmc_hist(posterior_95_pos, pars = c("(Intercept)", "offset_magnitude",
"sigma_curve_uncert"))
mcmc_hist(posterior_95_neg, pars = c("(Intercept)", "offset_magnitude",
"sigma_curve_uncert"))
## Lets build a function to extract it from our list
predict_singles_accuracy <- function (offset_dir, hpd_area, offset_magnitude,
sigma, curve_uncert){
## Forgive the if statements - this problem does not require high-power processing after all!
if (!exists("stan_offset_curve_sigma_comb")) {
warning("Load MCMC results please!") ## Every now and again, I build defensive habits :P
}
if (offset_dir == "pos" & hpd_area == "68") {
model <- as.array(stan_offset_curve_sigma_comb[[1]])
}
if (offset_dir == "neg" & hpd_area == "68") {
model <- as.array(stan_offset_curve_sigma_comb[[2]])
}
if (offset_dir == "pos" & hpd_area == "95") {
model <- as.array(stan_offset_curve_sigma_comb[[3]])
}
if (offset_dir == "neg" & hpd_area == "95") {
model <- as.array(stan_offset_curve_sigma_comb[[4]])
}
## Get the chain results out
intercepts <- model[1:1000, 1, 1]
offset_effects <- model[1:1000, 1, 2]
uncert_effects <- model[1:1000, 1, 3]
##Do the maths
sigma_curve_uncert <- sqrt((sigma ^ 2) + (curve_uncert ^ 2))
exp_term <- intercepts +
offset_magnitude * offset_effects +
sigma_curve_uncert * uncert_effects
pred_results <- 1 / (1 + exp(-exp_term))
pred_results
}
predict_singles_accuracy("pos", "68", 40, 10, 30)
predict_singles_accuracy("neg", "68", -40, 10, 30)
predict_singles_accuracy("pos", "95", 40, 10, 30)
predict_singles_accuracy("neg", "95", -40, 10, 30)
draw_predict_random <- function (model, param_plotted,
value_range, other_param){
###This function draws a single prediction from the STAN results
###It takes on the link to the STAN model, the value of the other parameter and a rangle of values for which to generate predictions.
###It returns a two column DF with input values and
draw_num <- sample(seq(1:1000), 1)
intercept <- model[draw_num, 1:4, 1] |>
median()
offset_effect <- model[draw_num, 1:4, 2] |>
median()
uncert_effect <- model[draw_num, 1:4, 3] |>
median()
if (str_detect(param_plotted, "offset")) {
exp_term <- intercept +
value_range * offset_effect +
other_param * uncert_effect
} else {
exp_term <- intercept +
value_range * uncert_effect +
other_param * offset_effect
}
pred_results <- 1 / (1 + exp(-exp_term))
pred_results <- data.frame(value_range, pred_results)
pred_results
}
draw_predict_random(posterior_68_pos, "offset", seq(0, 50, 1), 25)
draw_predict_random(posterior_68_pos, "", seq(0, 50, 1), 25)
draw_predict_median <- function (model, param_plotted,
value_range, other_param){
###This function draws a single prediction from the STAN results
###It takes on the link to the STAN model, the value of the other parameter and a rangle of values for which to generate predictions.
###It returns a two column DF with input values and
intercept <- model[1:1000, 1:4, 1] |>
median()
offset_effect <- model[1:1000, 1:4, 2] |>
median()
uncert_effect <- model[1:1000, 1:4, 3] |>
median()
if (str_detect(param_plotted, "offset")) {
exp_term <- intercept +
value_range * offset_effect +
other_param * uncert_effect
} else {
exp_term <- intercept +
value_range * uncert_effect +
other_param * offset_effect
}
pred_results <- 1 / (1 + exp(-exp_term))
pred_results <-  data.frame(value_range, pred_results)
pred_results
}
draw_predict_median(posterior_68_pos, "offset", seq(0, 50, 1), 25)
draw_predict_median(posterior_68_pos, "", seq(0, 50, 1), 25)
### Now plot over simulations
plot_stan_over_sims <- function (model, range_to_plot, variable, rounding,
xlab = ""){
single_cals_w_curve_uncert <- read_csv("single_cals_w_curve_uncert.csv") |>
mutate(sigma_curve_uncert = sqrt((measurement_error^2) + (curve_uncert^2)))
p <- plot_simulation_results_osc(range_to_plot = c(0, 50), hpd_area = "accuracy_68",
variable = "offset_magnitude", rounding = 2,
xlab = "Offset magnitude")
}
single_cals_w_curve_uncert <- read_csv("single_cals_w_curve_uncert.csv") |>
mutate(sigma_curve_uncert = sqrt((measurement_error^2) + (curve_uncert^2)))
p <- plot_simulation_results_osc(range_to_plot = c(0, 50), hpd_area = "accuracy_68",
variable = "offset_magnitude", rounding = 2,
xlab = "Offset magnitude")
library(modules)
## Clear/prime module
singles_sensitivity_m <- module()
saveRDS(singles_sensitivity_m, "singles_sensitivity_module.R")
## Clear/prime module
ssm <- module()
saveRDS(ssm, "singles_sensitivity_module.R")
ssm <- extend(ssm, {
plot_simulation_results_osc <- function(range_to_plot, hpd_area, variable,
rounding, xlab) {
##This function plots the simulation results for the purposes of the results graphing
single_cals_curve_uncert_mod <- read_csv("single_cals_w_curve_uncert.csv") %>%
mutate(sigma_curve_uncert = sqrt((measurement_error^2) + (curve_uncert^2)))
single_cals_curve_uncert_mod %>%
rename(variable_to_plot = variable, hpd_to_plot = hpd_area) %>%
filter(variable_to_plot >= range_to_plot[1] &
variable_to_plot <= range_to_plot) %>%
mutate(
variable_to_plot = plyr::round_any(variable_to_plot, rounding)
) %>%
select(variable_to_plot, hpd_to_plot) %>%
group_by(variable_to_plot) %>%
summarize(
ratio_accurate = mean(hpd_to_plot)
) %>%
ggplot(aes(x = variable_to_plot, y = ratio_accurate)) +
geom_bar(stat = 'identity', fill = "steelblue") +
theme_bw() +
theme(
panel.grid.minor = element_blank(),
panel.grid.major = element_blank(),
panel.border = element_blank(),
axis.line = element_line(colour = "grey50", linewidth = 0.5),
text = element_text(family = "Corbel")#,
#axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, size = 9)
) +
labs(
y = "Ratio accurate",
x = xlab
)
}
})
ssm <- extend(ssm, {
library(ggplot2)
plot_simulation_results_osc <- function(range_to_plot, hpd_area, variable,
rounding, xlab) {
##This function plots the simulation results for the purposes of the results graphing
single_cals_curve_uncert_mod <- read_csv("single_cals_w_curve_uncert.csv") %>%
mutate(sigma_curve_uncert = sqrt((measurement_error^2) + (curve_uncert^2)))
single_cals_curve_uncert_mod %>%
rename(variable_to_plot = variable, hpd_to_plot = hpd_area) %>%
filter(variable_to_plot >= range_to_plot[1] &
variable_to_plot <= range_to_plot) %>%
mutate(
variable_to_plot = plyr::round_any(variable_to_plot, rounding)
) %>%
select(variable_to_plot, hpd_to_plot) %>%
group_by(variable_to_plot) %>%
summarize(
ratio_accurate = mean(hpd_to_plot)
) %>%
ggplot(aes(x = variable_to_plot, y = ratio_accurate)) +
geom_bar(stat = 'identity', fill = "steelblue") +
theme_bw() +
theme(
panel.grid.minor = element_blank(),
panel.grid.major = element_blank(),
panel.border = element_blank(),
axis.line = element_line(colour = "grey50", linewidth = 0.5),
text = element_text(family = "Corbel")#,
#axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, size = 9)
) +
labs(
y = "Ratio accurate",
x = xlab
)
}
})
ssm <- extend(ssm, {
library(ggplot2)
library(readr)
plot_simulation_results_osc <- function(range_to_plot, hpd_area, variable,
rounding, xlab) {
##This function plots the simulation results for the purposes of the results graphing
single_cals_curve_uncert_mod <- read_csv("single_cals_w_curve_uncert.csv") %>%
mutate(sigma_curve_uncert = sqrt((measurement_error^2) + (curve_uncert^2)))
single_cals_curve_uncert_mod %>%
rename(variable_to_plot = variable, hpd_to_plot = hpd_area) %>%
filter(variable_to_plot >= range_to_plot[1] &
variable_to_plot <= range_to_plot) %>%
mutate(
variable_to_plot = plyr::round_any(variable_to_plot, rounding)
) %>%
select(variable_to_plot, hpd_to_plot) %>%
group_by(variable_to_plot) %>%
summarize(
ratio_accurate = mean(hpd_to_plot)
) %>%
ggplot(aes(x = variable_to_plot, y = ratio_accurate)) +
geom_bar(stat = 'identity', fill = "steelblue") +
theme_bw() +
theme(
panel.grid.minor = element_blank(),
panel.grid.major = element_blank(),
panel.border = element_blank(),
axis.line = element_line(colour = "grey50", linewidth = 0.5),
text = element_text(family = "Corbel")#,
#axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, size = 9)
) +
labs(
y = "Ratio accurate",
x = xlab
)
}
})
ssm <- extend(ssm, {
# library(ggplot2)
# library(readr)
plot_simulation_results_osc <- function(range_to_plot, hpd_area, variable,
rounding, xlab) {
##This function plots the simulation results for the purposes of the results graphing
single_cals_curve_uncert_mod <- read_csv("single_cals_w_curve_uncert.csv") %>%
mutate(sigma_curve_uncert = sqrt((measurement_error^2) + (curve_uncert^2)))
single_cals_curve_uncert_mod %>%
rename(variable_to_plot = variable, hpd_to_plot = hpd_area) %>%
filter(variable_to_plot >= range_to_plot[1] &
variable_to_plot <= range_to_plot) %>%
mutate(
variable_to_plot = plyr::round_any(variable_to_plot, rounding)
) %>%
select(variable_to_plot, hpd_to_plot) %>%
group_by(variable_to_plot) %>%
summarize(
ratio_accurate = mean(hpd_to_plot)
) %>%
ggplot(aes(x = variable_to_plot, y = ratio_accurate)) +
geom_bar(stat = 'identity', fill = "steelblue") +
theme_bw() +
theme(
panel.grid.minor = element_blank(),
panel.grid.major = element_blank(),
panel.border = element_blank(),
axis.line = element_line(colour = "grey50", linewidth = 0.5),
text = element_text(family = "Corbel")#,
#axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, size = 9)
) +
labs(
y = "Ratio accurate",
x = xlab
)
}
})
ssm <- extend(ssm, {
library(ggplot2)
library(readr)
library(dplyr)
plot_simulation_results_osc <- function(range_to_plot, hpd_area, variable,
rounding, xlab) {
##This function plots the simulation results for the purposes of the results graphing
single_cals_curve_uncert_mod <- read_csv("single_cals_w_curve_uncert.csv") %>%
mutate(sigma_curve_uncert = sqrt((measurement_error^2) + (curve_uncert^2)))
single_cals_curve_uncert_mod %>%
rename(variable_to_plot = variable, hpd_to_plot = hpd_area) %>%
filter(variable_to_plot >= range_to_plot[1] &
variable_to_plot <= range_to_plot) %>%
mutate(
variable_to_plot = plyr::round_any(variable_to_plot, rounding)
) %>%
select(variable_to_plot, hpd_to_plot) %>%
group_by(variable_to_plot) %>%
summarize(
ratio_accurate = mean(hpd_to_plot)
) %>%
ggplot(aes(x = variable_to_plot, y = ratio_accurate)) +
geom_bar(stat = 'identity', fill = "steelblue") +
theme_bw() +
theme(
panel.grid.minor = element_blank(),
panel.grid.major = element_blank(),
panel.border = element_blank(),
axis.line = element_line(colour = "grey50", linewidth = 0.5),
text = element_text(family = "Corbel")#,
#axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, size = 9)
) +
labs(
y = "Ratio accurate",
x = xlab
)
}
})
plot_simulation_results_osc <- function(range_to_plot, hpd_area, variable,
rounding, xlab) {
##This function plots the simulation results for the purposes of the results graphing
single_cals_curve_uncert_mod <- read_csv("single_cals_w_curve_uncert.csv") %>%
mutate(sigma_curve_uncert = sqrt((measurement_error^2) + (curve_uncert^2)))
single_cals_curve_uncert_mod %>%
rename(variable_to_plot = variable, hpd_to_plot = hpd_area) %>%
filter(variable_to_plot >= range_to_plot[1] &
variable_to_plot <= range_to_plot) %>%
mutate(
variable_to_plot = plyr::round_any(variable_to_plot, rounding)
) %>%
select(variable_to_plot, hpd_to_plot) %>%
group_by(variable_to_plot) %>%
summarize(
ratio_accurate = mean(hpd_to_plot)
) %>%
ggplot(aes(x = variable_to_plot, y = ratio_accurate)) +
geom_bar(stat = 'identity', fill = "steelblue") +
theme_bw() +
theme(
panel.grid.minor = element_blank(),
panel.grid.major = element_blank(),
panel.border = element_blank(),
axis.line = element_line(colour = "grey50", linewidth = 0.5),
text = element_text(family = "Corbel")#,
#axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, size = 9)
) +
labs(
y = "Ratio accurate",
x = xlab
)
}
### Now plot over simulations
plot_stan_over_sims <- function (model, range_to_plot, variable, rounding,
xlab = ""){
single_cals_w_curve_uncert <- read_csv("single_cals_w_curve_uncert.csv") |>
mutate(sigma_curve_uncert = sqrt((measurement_error^2) + (curve_uncert^2)))
p <- plot_simulation_results_osc(range_to_plot = c(0, 50), hpd_area = "accuracy_68",
variable = "offset_magnitude", rounding = 2,
xlab = "Offset magnitude")
}
single_cals_w_curve_uncert <- read_csv("single_cals_w_curve_uncert.csv") |>
mutate(sigma_curve_uncert = sqrt((measurement_error^2) + (curve_uncert^2)))
p <- plot_simulation_results_osc(range_to_plot = c(0, 50), hpd_area = "accuracy_68",
variable = "offset_magnitude", rounding = 2,
xlab = "Offset magnitude")
for (i in 1:50) {
sigma_curve_uncert <- sample(single_cals_w_curve_uncert$sigma_curve_uncert, 1)
sample_predict <- draw_predict_random(posterior_68_pos, "offset",
seq(0, 50, 1), sigma_curve_uncert) |>
rename(variable_to_plot = 1, ratio_accurate = 2)
p <- p + geom_line(data = sample_predict, linewidth = 0.1, linetype = 1)
}
median_predicts <- draw_predict_median(posterior_68_pos, "offset",
seq(0, 50, 1), 25) |>
rename(variable_to_plot = 1, ratio_accurate = 2)
p + geom_line(data = median_predicts)
### Now plot over simulations
plot_stan_over_sims <- function (model, range_to_plot, variable, rounding,
xlab = ""){
single_cals_w_curve_uncert <- read_csv("single_cals_w_curve_uncert.csv") |>
mutate(sigma_curve_uncert = sqrt((measurement_error^2) + (curve_uncert^2)))
p <- plot_simulation_results_osc(range_to_plot = c(0, 50), hpd_area = "accuracy_68",
variable = "offset_magnitude", rounding = 2,
xlab = "Offset magnitude")
}
single_cals_w_curve_uncert <- read_csv("single_cals_w_curve_uncert.csv") |>
mutate(sigma_curve_uncert = sqrt((measurement_error^2) + (curve_uncert^2)))
p <- plot_simulation_results_osc(range_to_plot = c(0, 50), hpd_area = "accuracy_68",
variable = "offset_magnitude", rounding = 2,
xlab = "Offset magnitude")
for (i in 1:200) {
sigma_curve_uncert <- sample(single_cals_w_curve_uncert$sigma_curve_uncert, 1)
sample_predict <- draw_predict_random(posterior_68_pos, "offset",
seq(0, 50, 1), sigma_curve_uncert) |>
rename(variable_to_plot = 1, ratio_accurate = 2)
p <- p + geom_line(data = sample_predict, linewidth = 0.1, linetype = 1)
}
median_predicts <- draw_predict_median(posterior_68_pos, "offset",
seq(0, 50, 1), 25) |>
rename(variable_to_plot = 1, ratio_accurate = 2)
p + geom_line(data = median_predicts)
### Now plot over simulations
plot_stan_over_sims <- function (model, range_to_plot, variable, rounding,
xlab = ""){
single_cals_w_curve_uncert <- read_csv("single_cals_w_curve_uncert.csv") |>
mutate(sigma_curve_uncert = sqrt((measurement_error^2) + (curve_uncert^2)))
p <- plot_simulation_results_osc(range_to_plot = c(0, 50), hpd_area = "accuracy_68",
variable = "offset_magnitude", rounding = 2,
xlab = "Offset magnitude")
}
single_cals_w_curve_uncert <- read_csv("single_cals_w_curve_uncert.csv") |>
mutate(sigma_curve_uncert = sqrt((measurement_error^2) + (curve_uncert^2)))
p <- plot_simulation_results_osc(range_to_plot = c(0, 50), hpd_area = "accuracy_68",
variable = "offset_magnitude", rounding = 2,
xlab = "Offset magnitude")
for (i in 1:500) {
sigma_curve_uncert <- sample(single_cals_w_curve_uncert$sigma_curve_uncert, 1)
sample_predict <- draw_predict_random(posterior_68_pos, "offset",
seq(0, 50, 1), sigma_curve_uncert) |>
rename(variable_to_plot = 1, ratio_accurate = 2)
p <- p + geom_line(data = sample_predict, linewidth = 0.1, linetype = 1)
}
median_predicts <- draw_predict_median(posterior_68_pos, "offset",
seq(0, 50, 1), 25) |>
rename(variable_to_plot = 1, ratio_accurate = 2)
p + geom_line(data = median_predicts)
### Now plot over simulations
plot_stan_over_sims <- function (model, range_to_plot, variable, rounding,
xlab = ""){
single_cals_w_curve_uncert <- read_csv("single_cals_w_curve_uncert.csv") |>
mutate(sigma_curve_uncert = sqrt((measurement_error^2) + (curve_uncert^2)))
p <- plot_simulation_results_osc(range_to_plot = c(0, 50), hpd_area = "accuracy_68",
variable = "offset_magnitude", rounding = 2,
xlab = "Offset magnitude")
}
single_cals_w_curve_uncert <- read_csv("single_cals_w_curve_uncert.csv") |>
mutate(sigma_curve_uncert = sqrt((measurement_error^2) + (curve_uncert^2)))
p <- plot_simulation_results_osc(range_to_plot = c(0, 50), hpd_area = "accuracy_68",
variable = "offset_magnitude", rounding = 2,
xlab = "Offset magnitude")
for (i in 1:50) {
sigma_curve_uncert <- sample(single_cals_w_curve_uncert$sigma_curve_uncert, 1)
sample_predict <- draw_predict_random(posterior_68_pos, "offset",
seq(0, 50, 1), sigma_curve_uncert) |>
rename(variable_to_plot = 1, ratio_accurate = 2)
p <- p + geom_line(data = sample_predict, linewidth = 0.1, linetype = 1)
}
median_predicts <- draw_predict_median(posterior_68_pos, "offset",
seq(0, 50, 1), 25) |>
rename(variable_to_plot = 1, ratio_accurate = 2)
p + geom_line(data = median_predicts)
library(tidyverse)
library(broom)
library(jtools)
library(rstan)
library(rstanarm)
library(bayesplot)
library(modules)
ssm <- read_rds("singles_sensitivity_module.R")
##List of all data to be loaded to run downstream project elements.
list_of_sims <- read_csv("sims_list.csv")
single_cals <- read_csv("simulation_results/singles_011_results.csv")
single_cals_log_diagnostics <- read_csv("model_results/single_cals_log_diagnostics.csv")
cal_curve <- read_csv("intcal_20_interpolated.csv")
single_cals_log_results <- read_csv("model_results/single_cals_log_results.csv")
single_cals_log_results_bin10 <- read_csv(
"model_results/single_cals_log_results_bin10.csv")
single_cals_w_curve_uncert <- read_csv("single_cals_w_curve_uncert.csv")
single_cals_curve_uncert_regr <- readRDS("single_cals_curve_uncert_regr.rds")
stan_offset_curve_sigma_comb <- read_rds("stan_offset_curve_sigma_comb.rds")
